{% extends "petjoy/base.html" %}
{% load static %}

{% block title %}เพิ่มสินค้าใหม่ - PetJoy{% endblock %}

{% block content %}
<style>
    .navbar { display: none !important; }
</style>
<!-- #เพิ่มสินค้าใหม่ -->
<div style="display: flex; gap: 2rem; max-width: 1200px; margin: 40px auto;">
    <aside class="sidebar">
        <nav class="sidebar-menu">
            <a href="{% url 'petjoy:entrepreneur-home' %}">โปรไฟล์</a>
            <a href="#">รายละเอียดคำสั่งซื้อ</a>
            <a href="{% url 'petjoy:product-list' %}">รายการสินค้า</a>
            <a href="#">ข้อความ</a>
            <a href="#">แก้ไขรายละเอียด</a>
            <a href="#">รายได้</a>
        </nav>
        <form method="post" action="{% url 'petjoy:logout' %}">
            {% csrf_token %}
            <button type="submit" class="logout-btn">ออกจากระบบ</button>
        </form>
    </aside>
    <div class="product-list-container" style="flex:1;">
        <div class="product-list-header">
            <h1>เพิ่มสินค้าใหม่</h1>
        </div>
        <form method="POST" enctype="multipart/form-data" class="simple-product-form" style="max-width: 420px; margin: 0 auto; background: #fff; padding: 28px 22px; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.07);">
            {% csrf_token %}
            <h2 style="text-align:center; font-size:1.15rem; font-weight:600; color:#2563eb; margin-bottom:18px;">➕ เพิ่มสินค้าใหม่</h2>
            <div class="form-group">
                <label for="id_name">ชื่อสินค้า</label>
                {{ form.name }}
            </div>
            <div class="form-group">
                <label for="id_total_stock">จำนวนสินค้าทั้งหมด</label>
                {{ form.total_stock }}
            </div>
            <div class="form-group">
                <label for="id_stock">จำนวนคงเหลือ</label>
                {{ form.stock }}
            </div>
            <div class="form-group">
                <label for="id_description">รายละเอียดสินค้า</label>
                {{ form.description }}
            </div>
            <div class="form-group">
                <label for="id_features">คุณสมบัติสินค้า</label>
                {{ form.features }}
            </div>
            <div class="form-group">
                <label for="id_price">ราคา (บาท)</label>
                {{ form.price }}
            </div>
            <div class="form-group">
                <label for="id_category">หมวดหมู่</label>
                {{ form.category }}
            </div>
            <!-- food-specific type selector (shown only when category is food) -->
            <div class="form-group" id="food-type-group" style="display:none;">
                <label for="id_food_type">ประเภทสัตว์</label>
                {{ form.food_type }}
            </div>
            <div class="form-group">
                <label for="id_image">รูปภาพสินค้า</label>
                {{ form.image }}
            </div>
            <button type="submit" class="btn-add-product white-btn" style="margin-top: 18px; padding: 10px 28px; border-radius: 8px; font-size: 1rem; font-weight: 500; background: #2563eb; color: #fff; border: none;">บันทึกสินค้า</button>
        </form>
        <style>
            .simple-product-form .form-group { margin-bottom: 16px; }
            .simple-product-form label { font-weight: 500; margin-bottom: 5px; display: block; color: #333; font-size: 1rem; }
            .simple-product-form input, .simple-product-form select, .simple-product-form textarea {
                width: 100%;
                padding: 9px 10px;
                border-radius: 7px;
                border: 1px solid #d1d5db;
                font-size: 1rem;
                background: #f9fafb;
                margin-top: 2px;
                font-family: inherit;
            }
            .simple-product-form textarea { min-height: 70px; }
            /* helper for hiding features when category is food */
            .simple-product-form .hidden-feature { display: none !important; }
        </style>
        <script>
            (function(){
                function isFoodOption(text){
                    if(!text) return false;
                    return /อาหาร|food/i.test(text);
                }

                function findFeaturesGroup(){
                    var marked = document.querySelector('[data-features-group]');
                    if(marked) return marked;
                    var label = document.querySelector('label[for="id_features"]');
                    if(label) return label.closest('.form-group');
                    var feat = document.getElementById('id_features');
                    if(feat) return feat.closest('.form-group');
                    return null;
                }

                function updateFormBasedOnCategory(){
                    var category = document.getElementById('id_category');
                    var featuresGroup = findFeaturesGroup();
                    var featuresInput = document.getElementById('id_features');
                    var foodTypeGroup = document.getElementById('food-type-group');
                    var foodTypeInput = document.getElementById('id_food_type');
                    if(!category) return;
                    var selected = category.options[category.selectedIndex];
                    var text = selected ? (selected.text || selected.innerText || '') : '';
                    var isFood = isFoodOption(text);

                    // Toggle features
                    if(featuresGroup && featuresInput){
                        if(isFood){
                            featuresGroup.classList.add('hidden-feature');
                            featuresInput.disabled = true;
                        } else {
                            featuresGroup.classList.remove('hidden-feature');
                            featuresInput.disabled = false;
                        }
                    }

                    // Toggle food-type selector
                    if(foodTypeGroup && foodTypeInput){
                        if(isFood){
                            foodTypeGroup.style.display = '';
                            foodTypeInput.disabled = false;
                        } else {
                            foodTypeGroup.style.display = 'none';
                            // clear selection to avoid accidental submission
                            foodTypeInput.selectedIndex = 0;
                            foodTypeInput.disabled = true;
                        }
                    }
                }

                document.addEventListener('DOMContentLoaded', function(){
                    var category = document.getElementById('id_category');
                    if(!category) return;
                    // mark the features group for reliability
                    var label = document.querySelector('label[for="id_features"]');
                    if(label){
                        var fg = label.closest('.form-group');
                        if(fg) fg.setAttribute('data-features-group','1');
                    }
                    // ensure food-type exists and is disabled by default
                    var foodTypeInput = document.getElementById('id_food_type');
                    if(foodTypeInput) foodTypeInput.disabled = true;

                    category.addEventListener('change', updateFormBasedOnCategory);
                    // initialize state
                    updateFormBasedOnCategory();
                });
            })();
        </script>
    </div>
</div>
{% endblock %}
