{% extends "petjoy/base.html" %}
{% load static %}
{% block title %}{{ product.name }} - PetJoy{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'product_detail.css' %}">

<div class="simple-detail-container">

    <div class="detail-header">
        <a href="javascript:history.back()" class="back-arrow">&#60;</a>
        <h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ product.name }}</h1>
    </div>

    <div class="detail-content-wrapper">

        <div class="detail-image-section">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="detail-product-image">
            {% endif %}

            <div class="store-info-section">
                {% if product.owner %}
                    {% if product.owner.profile_image %}
                        <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}">
                            <img src="{{ product.owner.profile_image.url }}" class="store-logo">
                        </a>
                    {% else %}
                        <img src="{% static 'images/‡∏£‡πâ‡∏≤‡∏ô.png' %}" class="store-logo">
                    {% endif %}
                    <div class="store-details">
                        <div class="store-name">{{ product.owner.store_name|cut:"-" }}</div>
                        <div class="store-buttons">
                            {% if user.is_authenticated %}
                                <a href="{% url 'petjoy:start_chat' product.owner.pk %}" class="store-btn chat-btn">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</a>
                            {% else %}
                                <a href="{% url 'petjoy:login' %}?next={% url 'petjoy:start_chat' product.owner.pk %}" class="store-btn chat-btn">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</a>
                            {% endif %}
                            <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}" class="store-btn view-store-btn">‡∏î‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>
                        </div>
                    </div>
                {% else %}
                    <div class="store-details">
                        <div class="store-name">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                {% endif %}
            </div>

            <div class="reviews-section">
                <h3>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ({{ reviews.count }})</h3>
                {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-user">{{ review.user.profile.name|default:review.user.username }}</span>
                            <span class="review-date">{{ review.created_at|date:"d M Y" }}</span>
                        </div>
                        <div class="star-rating">‚òÖ {{ review.rating }}/5</div>
                        <p class="review-comment">{{ review.comment }}</p>
                        {% if review.reply %}
                            <div class="review-reply"><strong>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> {{ review.reply.message }}</div>
                        {% endif %}
                    </div>
                {% empty %}
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                {% endfor %}
            </div>
        </div>

        <div class="detail-info-section">

            <h2 class="detail-product-name">{{ product.name }}</h2>
            <p class="detail-product-category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ product.category.display_name }}</p>

            {% if user.is_authenticated %}
                <button id="favoriteBtn" class="favorite-toggle favorite-heart {% if product in user.profile.favorites.all %}fav-active{% endif %}" data-product-id="{{ product.pk }}">
                    <i class="{% if product in user.profile.favorites.all %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
                </button>
            {% endif %}

            <p class="detail-product-price">‡∏£‡∏≤‡∏Ñ‡∏≤: {{ product.price }} ‡∏ö‡∏≤‡∏ó</p>

            <div class="action-buttons" style="display:flex; gap:12px; margin-top:20px;">
                <button type="button"
                        class="btn-add-cart"
                        id="btnAddToCart"
                        data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                </button>

                <button type="button" 
                        class="btn-buy-now"
                        id="btnBuyNow"
                        style="background: #E65100; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;"
                        data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    ‚ö° ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>

            <div id="quantityModal" class="modal-overlay" style="display:none;">
                <div class="modal-box">
                    <h3 id="modalTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="modal-qty-selector">
                        <button type="button" id="qtyMinus">-</button>
                        <input type="text" id="modalQtyInput" value="1" readonly>
                        <button type="button" id="qtyPlus">+</button>
                    </div>
                    
                    <form id="cartForm" method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" id="modalQtyHidden" name="quantity" value="1">
                        
                        <button type="submit" class="modal-confirm-btn" id="modalConfirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button type="button" class="modal-cancel-btn" onclick="closeQtyModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                </div>
            </div>

            {% if product.features %}
                <h3>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <p>{{ product.features|linebreaks }}</p>
            {% endif %}

            <div class="detail-product-description">
                <h3>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</h3>
                <p>{{ product.description|linebreaks }}</p>
            </div>

            <div class="report-section" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; text-align: right;">
                <button type="button" class="btn-report" onclick="openReportModal()" data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    <i class="fa-solid fa-flag"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>

            <div id="reportModal" class="modal-overlay" style="display:none;">
                <div class="modal-box" style="max-width: 400px;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <form id="reportForm" data-report-url="{% url 'petjoy:report_product' product.id %}">
                        {% csrf_token %}
                        <select name="reason" id="reportReason" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                            <option value="inappropriate">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</option>
                            <option value="scam">‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á</option>
                            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                        <textarea name="details" id="reportDetails" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
                        <button type="button" onclick="submitReportNew()" class="modal-confirm-btn">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        <button type="button" onclick="closeReportModal()" class="modal-cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="{% static 'js/favorites.js' %}"></script>

<script>
    // --- Logic ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ---
    const modal = document.getElementById('quantityModal');
    const cartForm = document.getElementById('cartForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    
    // URL ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
    const urlAddToCart = "{% url 'petjoy:cart-add' %}";
    const urlBuyNow = "{% url 'petjoy:buy_now' %}"; // URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á

    function checkLogin(btn) {
        const loggedIn = btn.dataset.loggedIn === '1';
        if (!loggedIn) {
            Swal.fire({
                icon: 'warning',
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                confirmButtonText: '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô',
                confirmButtonColor: '#E65100'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'petjoy:login' %}?next={{ request.path }}";
                }
            });
            return false;
        }
        return true;
    }

    function openQtyModal() {
        modal.style.display = 'flex';
        // Reset qty
        document.getElementById('modalQtyInput').value = 1;
        document.getElementById('modalQtyHidden').value = 1;
    }

    function closeQtyModal() {
        modal.style.display = 'none';
    }

    // 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"
    document.getElementById('btnAddToCart').addEventListener('click', function() {
        if(!checkLogin(this)) return;
        
        cartForm.action = urlAddToCart; // ‡∏™‡πà‡∏á‡πÑ‡∏õ API ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        modalTitle.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤";
        modalConfirmBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°";
        openQtyModal();
    });

    // 2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" (Buy Now)
    document.getElementById('btnBuyNow').addEventListener('click', function() {
        if(!checkLogin(this)) return;

        cartForm.action = urlBuyNow; // ‡∏™‡πà‡∏á‡πÑ‡∏õ API ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢
        modalTitle.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
        modalConfirmBtn.innerText = "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
        openQtyModal();
    });

    // Logic ‡∏ö‡∏ß‡∏Å‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Modal
    const qtyInput = document.getElementById('modalQtyInput');
    const qtyHidden = document.getElementById('modalQtyHidden');
    
    document.getElementById('qtyMinus').addEventListener('click', function(){
        let val = parseInt(qtyInput.value) || 1;
        if(val > 1) {
            val--;
            qtyInput.value = val;
            qtyHidden.value = val;
        }
    });
    
    document.getElementById('qtyPlus').addEventListener('click', function(){
        let val = parseInt(qtyInput.value) || 1;
        // ‡πÄ‡∏ä‡πá‡∏Ñ stock ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        val++;
        qtyInput.value = val;
        qtyHidden.value = val;
    });

    // --- Logic Report Modal ---
    function openReportModal() {
        // (Logic ‡πÄ‡∏î‡∏¥‡∏°)
        const btn = document.querySelector('.btn-report');
        if(!checkLogin(btn)) return;
        document.getElementById('reportModal').style.display = 'flex';
    }
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }
    function submitReportNew() {
        // (Logic ‡∏™‡πà‡∏á Report ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const form = document.getElementById('reportForm');
        const url = form.getAttribute('data-report-url');
        const reason = document.getElementById('reportReason').value;
        const details = document.getElementById('reportDetails').value;
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken},
            body: new URLSearchParams({'reason': reason, 'details': details})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success){
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                closeReportModal();
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error, 'error');
            }
        });
    }

    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    window.onclick = function(event) {
        if (event.target == modal) closeQtyModal();
        if (event.target == document.getElementById('reportModal')) closeReportModal();
    }
</script>
{% endblock %}