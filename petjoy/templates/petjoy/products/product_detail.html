{% extends "petjoy/base.html" %}
{% load static %}
<!-- สินค้าชิ้นแรก ไม้ล่อแมว -->
{% block title %}{{ product.name }} - PetJoy{% endblock %}

{% block content %}
<div class="simple-detail-container">

    <div class="detail-header">
        <a href="javascript:history.back()" class="back-arrow">&#60;</a>
        <h1>รายละเอียดสินค้า: {{ product.name }}</h1>
    </div>

    <div class="detail-content-wrapper">

        <div class="detail-image-section">

            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="detail-product-image">
            {% endif %}

            <div class="store-info-section">
                {% if product.owner %}
                    {% if product.owner.profile_image %}
                        {% if user.is_authenticated and user == product.owner.user %}
                            <a href="{% url 'petjoy:entrepreneur-home' %}"><img src="{{ product.owner.profile_image.url }}" alt="{{ product.owner.store_name|cut:"-" }}" class="store-logo"></a>
                        {% else %}
                            <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}"><img src="{{ product.owner.profile_image.url }}" alt="{{ product.owner.store_name|cut:"-" }}" class="store-logo"></a>
                        {% endif %}
                        {% else %}
                            {% if user.is_authenticated and user == product.owner.user %}
                            <a href="{% url 'petjoy:entrepreneur-home' %}"><img src="{% static 'images/ร้าน.png' %}" alt="{{ product.owner.store_name|cut:"-" }}" class="store-logo"></a>
                        {% else %}
                            <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}"><img src="{% static 'images/ร้าน.png' %}" alt="{{ product.owner.store_name|cut:"-" }}" class="store-logo"></a>
                        {% endif %}
                    {% endif %}
                    <div class="store-details">
                        <div class="store-name">
                            {% if user.is_authenticated and user == product.owner.user %}
                                <a href="{% url 'petjoy:entrepreneur-home' %}">{{ product.owner.store_name|cut:"-" }}</a>
                            {% else %}
                                <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}">{{ product.owner.store_name|cut:"-" }}</a>
                            {% endif %}
                        </div>
                        <div class="store-buttons">
                            <a href="#" class="store-btn chat-btn">แชทเลย</a>
                            {% if user.is_authenticated and user == product.owner.user %}
                                <a href="{% url 'petjoy:entrepreneur-home' %}" class="store-btn view-store-btn">ดูร้านค้า</a>
                            {% else %}
                                <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}" class="store-btn view-store-btn">ดูร้านค้า</a>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <img src="{% static 'images/ร้าน.png' %}" alt="Store Logo" class="store-logo">
                    <div class="store-details">
                        <div class="store-name">ร้านผู้ขาย</div>
                        <div class="store-buttons">
                            <a href="#" class="store-btn chat-btn">แชทเลย</a>
                            <a href="#" class="store-btn view-store-btn">ดูร้านค้า</a>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="reviews-section">
                <h3>รีวิวจากลูกค้า ({{ reviews.count }})</h3>
                {% for review in reviews %}
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-user">{{ review.user.username }}</span>
                        <span class="review-date">{{ review.created_at|date:"d M Y" }}</span>
                    </div>
                    <div class="star-rating">
                        {% if review.rating == 5 %}★★★★★{% endif %}
                        {% if review.rating == 4 %}★★★★<span class="empty-star">★</span>{% endif %}
                        {% if review.rating == 3 %}★★★<span class="empty-star">★★</span>{% endif %}
                        {% if review.rating == 2 %}★★<span class="empty-star">★★★</span>{% endif %}
                        {% if review.rating == 1 %}★<span class="empty-star">★★★★</span>{% endif %}
                    </div>
                    <p class="review-comment">{{ review.comment }}</p>
                </div>
                {% empty %}
                <p>ยังไม่มีรีวิวสำหรับสินค้าชิ้นนี้</p>
                {% endfor %}
            </div>

        </div>

        <div class="detail-info-section">

            <h2 class="detail-product-name">{{ product.name }}</h2>
                {% if user.is_authenticated %}
                <button id="favoriteBtn" class="favorite-toggle detail-fav" data-product-id="{{ product.pk }}" aria-pressed="{% if product in user.profile.favorites.all %}true{% else %}false{% endif %}">
                    {% if product in user.profile.favorites.all %}❤️{% else %}♡{% endif %}
                </button>
                {% else %}
                <button type="button" class="detail-fav anonymous-fav" title="กรุณาเข้าสู่ระบบเพื่อบันทึก">♡</button>
                <script>
                    (function(){
                        var btn = document.querySelector('.anonymous-fav');
                        if (!btn) return;
                        btn.addEventListener('click', function(){
                            var ok = confirm('กรุณาเข้าสู่ระบบเพื่อบันทึกรายการโปรด\n\nคลิก ตกลง เพื่อไปยังหน้าล็อกอิน');
                            if (ok) {
                                window.location.href = "{% url 'petjoy:login' %}?next={% url 'petjoy:product-detail' product.id %}";
                            }
                        });
                    })();
                </script>
                {% endif %}
            <p class="detail-product-price">ราคา: {{ product.price }} บาท</p>
            <p class="detail-product-category">หมวดหมู่: {{ product.category.display_name }}</p>
            {# Display the seller-selected food type when available (dog/cat) #}
            {% if product.food_type %}
                <p class="detail-product-foodtype">ประเภทสัตว์: {% if product.food_type == 'dog' %}สุนัข{% elif product.food_type == 'cat' %}แมว{% else %}—{% endif %}</p>
            {% endif %}
            
            <div class="quantity-selector" style="margin-bottom: 18px;">
                <span>จำนวน</span>
                <div class="quantity-controls" style="display: flex; align-items: center; gap: 8px;">
                    <button class="quantity-btn minus" type="button" onclick="changeQuantity(-1)">-</button>
                    <input type="text" class="quantity-input" id="quantityInput" value="1" style="width: 48px; text-align: center; font-size: 1.1rem;">
                    <button class="quantity-btn plus" type="button" onclick="changeQuantity(1)">+</button>
                </div>
            </div>

            <div class="action-buttons" style="display: flex; gap: 12px;">
                <button type="button" class="action-btn" style="flex:1; background: #F3F4F6; color: #ce4d2d;">เพิ่มลงตะกร้า</button>
                <button type="button" class="action-btn" style="flex:1; background: #ce4d2d; color: #fff;">สั่งซื้อสินค้า</button>
            </div>
            <style>
                .action-btn {
                    border-radius: 8px;
                    border: none;
                    padding: 10px 0;
                    font-weight: 500;
                    font-size: 1rem;
                    width: 100%;
                    min-width: 0;
                    box-sizing: border-box;
                    transition: background 0.2s;
                }
                .action-btn:active {
                    opacity: 0.9;
                }
            </style>
            <script>
                function changeQuantity(delta) {
                    var input = document.getElementById('quantityInput');
                    var value = parseInt(input.value) || 1;
                    value += delta;
                    if (value < 1) value = 1;
                    input.value = value;
                }
            </script>

            <div class="detail-product-description">
                <h3>คำอธิบาย</h3>
                <p>{{ product.description|linebreaks }}</p>
            </div>
                {% comment %} Hide features if seller set a food_type OR if category name suggests food (contains 'อาหาร'/'food') {% endcomment %}
                {% if product.food_type %}
                    {# seller chose a food type — do not show features #}
                {% else %}
                    {% with cat_name=product.category.display_name|default_if_none:""|lower %}
                        {% if not "อาหาร" in cat_name and not "food" in cat_name %}
                            <h3>คุณสมบัติ</h3>
                            <p>{{ product.features|linebreaks }}</p>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>

        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/favorites.js' %}"></script>
{% endblock %}
