{% extends "petjoy/base.html" %}
{% load static %}
{% block title %}{{ product.name }} - PetJoy{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'product_detail.css' %}">

<style>
    .star-rating i {
        color: #FFC107;
        font-size: 0.9rem;
        margin-right: 1px;
    }
    .star-rating i.empty {
        color: #e0e0e0;
    }

    .favorite-toggle {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        transition: transform 0.2s;
        color: #ccc;
    }
    .favorite-toggle:hover {
        transform: scale(1.1);
    }
    .fav-active {
        color: #ff4081 !important;
    }
    .fav-active i {
        font-weight: 900;
    }
</style>

<div class="simple-detail-container">

    <div class="detail-header">
        <a href="javascript:history.back()" class="back-arrow">&#60;</a>
        <h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ product.name }}</h1>
    </div>

    <div class="detail-content-wrapper">

        <div class="detail-image-section">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="detail-product-image">
            {% endif %}

            <div class="store-info-section">
                {% if product.owner %}
                    {% if product.owner.profile_image %}
                        <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}">
                            <img src="{{ product.owner.profile_image.url }}" class="store-logo">
                        </a>
                    {% else %}
                        <img src="{% static 'images/‡∏£‡πâ‡∏≤‡∏ô.png' %}" class="store-logo">
                    {% endif %}
                    <div class="store-details">
                        <div class="store-name">{{ product.owner.store_name|cut:"-" }}</div>
                        <div class="store-buttons">
                            {% if user.is_authenticated %}
                                <a href="{% url 'petjoy:start_chat' product.owner.pk %}" class="store-btn chat-btn">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</a>
                            {% else %}
                                <a href="{% url 'petjoy:login' %}?next={% url 'petjoy:start_chat' product.owner.pk %}" class="store-btn chat-btn">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</a>
                            {% endif %}
                            <a href="{% url 'petjoy:entrepreneur-public' product.owner.pk %}" class="store-btn view-store-btn">‡∏î‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>
                        </div>
                    </div>
                {% else %}
                    <div class="store-details">
                        <div class="store-name">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                {% endif %}
            </div>

            <div class="reviews-section">
                <h3>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ({{ reviews.count }})</h3>
                
                {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-user">
                                {{ review.user.profile.name|default:review.user.get_full_name|default:review.user.username }}
                            </span>
                            <span class="review-date">{{ review.created_at|date:"d M Y" }}</span>
                        </div>
                        
                        <div class="star-rating" data-rating="{{ review.rating }}"></div>
                        <p class="review-comment">{{ review.comment }}</p>
                        
                        {% if review.reply %}
                            <div class="review-reply"><strong>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> {{ review.reply.message }}</div>
                        {% endif %}
                    </div>
                {% empty %}
                    <p style="color:#777; font-style:italic;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
                {% endfor %}
            </div>
        </div>

        <div class="detail-info-section">

            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h2 class="detail-product-name">{{ product.name }}</h2>
                    <p class="detail-product-category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ product.category.display_name }}</p>
                </div>

                <button id="favoriteBtn" 
                        class="favorite-toggle {% if user.is_authenticated and product in user.profile.favorites.all %}fav-active{% endif %}" 
                        data-product-id="{{ product.pk }}"
                        data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    <i class="{% if user.is_authenticated and product in user.profile.favorites.all %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
                </button>
            </div>

            <p class="detail-product-price">‡∏£‡∏≤‡∏Ñ‡∏≤: {{ product.price }} ‡∏ö‡∏≤‡∏ó</p>

            <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å -->
            {% if product.stock <= 0 %}
                <p style="color:red; font-weight:bold;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</p>
            {% else %}
                <p style="color:green;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ product.stock }} ‡∏ä‡∏¥‡πâ‡∏ô</p>
            {% endif %}

            <div class="action-buttons" style="display:flex; gap:12px; margin-top:20px;">
                <button type="button"
                        class="btn-add-cart"
                        id="btnAddToCart"
                        {% if product.stock <= 0 %}disabled{% endif %}
                        data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                </button>

                <button type="button" 
                        class="btn-buy-now"
                        id="btnBuyNow"
                        {% if product.stock <= 0 %}disabled{% endif %}
                        style="background: #E65100; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;"
                        data-logged-in="{% if user.is_authenticated %}1{% else %}0{% endif %}">
                    ‚ö° ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>

            <div id="quantityModal" class="modal-overlay" style="display:none;">
                <div class="modal-box">
                    <h3 id="modalTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="modal-qty-selector">
                        <button type="button" id="qtyMinus">-</button>
                        <input type="text" id="modalQtyInput" value="1" readonly>
                        <button type="button" id="qtyPlus">+</button>
                    </div>
                    
                    <form id="cartForm" method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" id="modalQtyHidden" name="quantity" value="1">
                        
                        <button type="submit" class="modal-confirm-btn" id="modalConfirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button type="button" class="modal-cancel-btn" onclick="closeQtyModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                </div>
            </div>

            {% if product.features %}
                <h3>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <p>{{ product.features|linebreaks }}</p>
            {% endif %}

            <div class="detail-product-description">
                <h3>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</h3>
                <p>{{ product.description|linebreaks }}</p>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="{% static 'js/favorites.js' %}"></script>

<script>
    // --- Logic ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≤‡∏ß‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (Render Stars) ---
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.star-rating').forEach(function(starContainer) {
            const rating = parseInt(starContainer.dataset.rating) || 0;
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    html += '<i class="fa-solid fa-star"></i>'; // ‡∏î‡∏≤‡∏ß‡πÄ‡∏ï‡πá‡∏°
                } else {
                    html += '<i class="fa-regular fa-star empty"></i>'; // ‡∏î‡∏≤‡∏ß‡∏ß‡πà‡∏≤‡∏á
                }
            }
            starContainer.innerHTML = html;
        });
    });

    // --- Logic ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ---
    const modal = document.getElementById('quantityModal');
    const cartForm = document.getElementById('cartForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    
    // URL ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
    const urlAddToCart = "{% url 'petjoy:cart-add' %}";
    const urlBuyNow = "{% url 'petjoy:buy_now' %}"; 

    function checkLogin(btn) {
        const loggedIn = btn.dataset.loggedIn === '1';
        if (!loggedIn) {
            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancel Button)
            Swal.fire({
                icon: 'warning',
                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                showCancelButton: true, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                confirmButtonText: '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                confirmButtonColor: '#E65100',
                cancelButtonColor: '#757575'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'petjoy:login' %}?next={{ request.path }}";
                }
            });
            return false;
        }
        return true;
    }

    function openQtyModal() {
        modal.style.display = 'flex';
        // Reset qty
        document.getElementById('modalQtyInput').value = 1;
        document.getElementById('modalQtyHidden').value = 1;
    }

    function closeQtyModal() {
        modal.style.display = 'none';
    }

    // 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"
    document.getElementById('btnAddToCart').addEventListener('click', function() {
        if(!checkLogin(this)) return;
        
        cartForm.action = urlAddToCart; 
        modalTitle.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤";
        modalConfirmBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°";
        openQtyModal();
    });

    // 2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" (Buy Now)
    document.getElementById('btnBuyNow').addEventListener('click', function() {
        if(!checkLogin(this)) return;

        cartForm.action = urlBuyNow; 
        modalTitle.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
        modalConfirmBtn.innerText = "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
        openQtyModal();
    });

    // Logic ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏à (Favorite) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
    document.getElementById('favoriteBtn').addEventListener('click', function(e) {
        const loggedIn = this.dataset.loggedIn === '1';
        if (!loggedIn) {
            e.preventDefault();
            e.stopPropagation();
            checkLogin(this); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ Login ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
        }
        // ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ favorites.js ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
    });

    // Logic ‡∏ö‡∏ß‡∏Å‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Modal
    const qtyInput = document.getElementById('modalQtyInput');
    const qtyHidden = document.getElementById('modalQtyHidden');
    
    document.getElementById('qtyMinus').addEventListener('click', function(){
        let val = parseInt(qtyInput.value) || 1;
        if(val > 1) {
            val--;
            qtyInput.value = val;
            qtyHidden.value = val;
        }
    });
    
    document.getElementById('qtyPlus').addEventListener('click', function(){
        let val = parseInt(qtyInput.value) || 1;
        val++;
        qtyInput.value = val;
        qtyHidden.value = val;
    });

    // --- Logic Report Modal ---
    function openReportModal() {
        const btn = document.querySelector('.btn-report');
        if(!checkLogin(btn)) return;
        document.getElementById('reportModal').style.display = 'flex';
    }
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }
    function submitReportNew() {
        const form = document.getElementById('reportForm');
        const url = form.getAttribute('data-report-url');
        const reason = document.getElementById('reportReason').value;
        const details = document.getElementById('reportDetails').value;
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken},
            body: new URLSearchParams({'reason': reason, 'details': details})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success){
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                closeReportModal();
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error, 'error');
            }
        });
    }

    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    window.onclick = function(event) {
        if (event.target == modal) closeQtyModal();
        if (event.target == document.getElementById('reportModal')) closeReportModal();
    }
</script>
{% endblock %}