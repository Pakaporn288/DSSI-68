{% extends 'petjoy/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | PetJoy{% endblock %}

{% block content %}

<div class="cart-container">

    <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
        <a href="{% url 'petjoy:homepage' %}"
           style="
               display:inline-flex;
               align-items:center;
               gap:6px;
               padding:10px 16px;
               background:#fff3eb;
               color:#ff7a00;
               border-radius:999px;
               font-size:14px;
               font-weight:600;
               text-decoration:none;
               border:1px solid #ffd2b8;
               transition: all 0.2s;
           "
           onmouseover="this.style.background='#ff7a00'; this.style.color='white';"
           onmouseout="this.style.background='#fff3eb'; this.style.color='#ff7a00';">
            <i class="ri-arrow-left-line"></i>
            ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        </a>
        <h1 class="cart-title" style="margin:0;">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
    </div>

    {% if cart_items %}
    <div class="cart-items-list">

        {% for item in cart_items %}
        <div class="cart-item-card">

            <div class="cart-item-left">
                <a href="{% url 'petjoy:product-detail' item.product.id %}" class="cart-img-link">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" class="cart-img">
                    {% else %}
                        <img src="{% static 'images/no-image.png' %}" class="cart-img">
                    {% endif %}
                </a>
            </div>

            <div class="cart-item-right">

                <h2 class="cart-item-name">
                    <a href="{% url 'petjoy:product-detail' item.product.id %}" class="cart-item-name-link">
                        {{ item.product.name }}
                    </a>
                </h2>

                <p class="cart-item-shop">
                    ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:
                    {% if item.product.owner %}
                        {{ item.product.owner.store_name }}
                    {% else %}
                        -
                    {% endif %}
                </p>

                <p class="cart-item-price">
                    ‡∏£‡∏≤‡∏Ñ‡∏≤ {{ item.product.price|floatformat:0|intcomma }} ‡∏ö‡∏≤‡∏ó
                </p>

                <div class="qty-controls">
                    <form method="POST" action="{% url 'petjoy:update-cart' %}">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="hidden" name="quantity" value="{{ item.quantity|add:'-1' }}">
                        <button type="submit" class="qty-btn">‚àí</button>
                    </form>

                    <span class="qty-number">{{ item.quantity|intcomma }}</span>

                    <form method="POST" action="{% url 'petjoy:update-cart' %}">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="hidden" name="quantity" value="{{ item.quantity|add:'1' }}">
                        <button type="submit" class="qty-btn">+</button>
                    </form>
                </div>

                <p class="cart-item-total">
                    ‡∏£‡∏ß‡∏° <strong>{{ item.total_price|floatformat:0|intcomma }}</strong> ‡∏ö‡∏≤‡∏ó
                </p>

                <div class="cart-item-actions">
                    <a href="{% url 'petjoy:checkout' %}?selected_items={{ item.id }}"
                       class="btn-order-single">
                        ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
                    </a>

                    <a href="{% url 'petjoy:remove-from-cart' item.id %}" class="btn-remove">
                        ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </a>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

    <div class="cart-summary-new">
        <p class="summary-line">
            <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong>
            {{ total_price|floatformat:0|intcomma }} ‡∏ö‡∏≤‡∏ó
        </p>

        <p class="summary-line">
            <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong>
            {{ total_items|intcomma }} ‡∏ä‡∏¥‡πâ‡∏ô
        </p>

        <button class="btn-checkout-orange" id="openCheckoutPopup">
            ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        </button>
    </div>

    {% else %}
        <div class="cart-empty">
            üõí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </div>
    {% endif %}

</div>

<div id="checkoutPopup" class="popup-overlay">
    <div class="popup-box">

        <h2 class="popup-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>

        <form id="checkoutForm">

            <div class="popup-items">
                {% for item in cart_items %}
                <label class="popup-item">
                    <input type="checkbox"
                        name="selected_items"
                        value="{{ item.id }}"
                        class="popup-checkbox"
                        data-price="{{ item.product.price }}"
                        data-qty="{{ item.quantity }}">

                    <img src="{{ item.product.image.url }}" class="popup-img">

                    <div class="popup-info">
                        <p class="popup-name">{{ item.product.name }}</p>
                        <p class="popup-price">
                            {{ item.product.price|floatformat:0|intcomma }} √ó {{ item.quantity }}
                            = <strong>{{ item.total_price|floatformat:0|intcomma }}</strong>
                        </p>
                    </div>
                </label>
                {% endfor %}
            </div>

            <div class="popup-summary">
                ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:
                <span id="popupTotal" style="font-weight:700;color:#E65100;">0</span> ‡∏ö‡∏≤‡∏ó
            </div>

            <div class="popup-actions">
                <button type="button" id="cancelPopup" class="popup-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="popup-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>

        </form>

    </div>
</div>

<script>
function calculatePopupTotal() {
    let total = 0;
    document.querySelectorAll("input[name='selected_items']:checked").forEach(chk => {
        let price = parseFloat(chk.dataset.price);
        let qty = parseInt(chk.dataset.qty);
        total += price * qty;
    });
    document.getElementById("popupTotal").textContent = total.toLocaleString();
}

document.getElementById("openCheckoutPopup").addEventListener("click", () => {
    document.getElementById("checkoutPopup").style.display = "flex";
    calculatePopupTotal();
});

document.getElementById("cancelPopup").addEventListener("click", () => {
    document.getElementById("checkoutPopup").style.display = "none";
});

document.querySelectorAll("input[name='selected_items']").forEach(el => {
    el.addEventListener("change", calculatePopupTotal);
});

document.getElementById("checkoutForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const selected = [...document.querySelectorAll("input[name='selected_items']:checked")]
        .map(el => el.value);

    if (selected.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        return;
    }

    const checkoutUrl = "{% url 'petjoy:checkout' %}";
    const params = new URLSearchParams();
    selected.forEach(id => params.append('selected_items', id));
    window.location.href = checkoutUrl + '?' + params.toString();
});
</script>

{% endblock %}