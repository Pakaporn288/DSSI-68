{% extends "petjoy/base.html" %}
{% load static %}
{% load humanize %}
{% block title %}‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ | PetJoy{% endblock %}

{% block content %}

<style>
  :root{
    --brand:#ff8c00;
    --brand-dark:#e57e00;
    --accent:#28a745;
    --muted:#6b6b6b;
    --card-bg:#ffffff;
    --surface:#fafafa;
    --radius:10px;
    --max-width:1100px;
  }
  body {background: linear-gradient(180deg, #f7f9fb 0%, #ffffff 100%);} 

  /* ‚≠ê 1. ‡∏•‡∏ö‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ ‚≠ê */
  a { text-decoration: none !important; }

  .checkout-wrap{max-width:var(--max-width); margin:32px auto; padding:20px; box-sizing:border-box}
  .checkout-grid{display:grid; grid-template-columns:1fr 360px; gap:22px}

  /* Mobile stack */
  @media (max-width:900px){
    .checkout-grid{grid-template-columns:1fr}
    .summary-card{order:2}
  }

  .card{background:var(--card-bg); border-radius:var(--radius); box-shadow:0 6px 18px rgba(16,24,40,0.06); padding:18px}
  .section-header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .section-title{font-weight:800; font-size:1.05rem}
  .muted{color:var(--muted); font-size:0.95rem}

  /* Steps */
  .steps{display:flex; gap:12px; align-items:center; margin-bottom:14px}
  .step{display:flex; align-items:center; gap:10px}
  .circle{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff}
  .circle.inactive{background:#ddd; color:#333} .circle.active{background:var(--brand)}
  .step-label{font-size:0.88rem}

  /* Address */
  .current-address{display:flex; flex-direction:column; gap:6px}
  .change-link{background:none; border:1px solid var(--brand); color:var(--brand); padding:6px 10px; border-radius:6px; font-weight:700; text-decoration:none}

  /* Items table */
  .items-list{display:flex; flex-direction:column; gap:12px}
  .item-row{display:flex; gap:12px; align-items:center; padding:12px; border-radius:8px; background:var(--surface)}
  .item-img{width:64px; height:64px; object-fit:cover; border-radius:8px}
  .item-meta{flex:1}
  .item-price{min-width:110px; text-align:right; font-weight:700}

  .total-line{display:flex; justify-content:space-between; font-weight:800; font-size:1.05rem; padding-top:8px; border-top:1px dashed #e6e6e6}

  /* Summary card */
  .summary-card{position:sticky; top:24px}
  .summary-row{display:flex; justify-content:space-between; padding:6px 0; color:var(--muted)}
  .summary-total{font-size:1.2rem; color:var(--brand); font-weight:900}

  /* Buttons */
  .btn{display:inline-flex; align-items:center; gap:8px; justify-content:center; border-radius:10px; padding:10px 16px; font-weight:800; cursor:pointer; border:0;}
  .btn-primary{background:var(--brand); color:#fff; border:0}
  .btn-ghost{background:#fff; color:#333; border:1px solid #ddd}

  /* Payment options */
  .payment-list{display:flex; flex-direction:column; gap:10px}
  .payment-card{border:1px solid #ececec; padding:14px; border-radius:8px; display:flex; gap:12px; align-items:flex-start}
  .payment-card input{margin-top:3px}
  .bank-details{font-size:0.95rem; color:var(--muted); width: 100%;}
  
  /* Shop Group Styles */
  .shop-group { border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; overflow: hidden; background: white; }
  .shop-header { background: #fff8f0; padding: 10px 15px; font-weight: 700; color: #d35400; border-bottom: 1px solid #ffe0b2; display: flex; align-items: center; gap: 8px; }
  .shop-transfer-group { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
  .shop-title { font-weight: 700; color: #333; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
  .price-summary-row { display: flex; justify-content: space-between; padding: 5px 15px; font-size: 0.9rem; color: #555; }
  .price-summary-row.total { border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 5px; padding-bottom: 15px; font-weight: 800; color: #333; font-size: 1rem; }

  /* Modal */
  .modal-overlay{position:fixed; inset:0; display:none; background:rgba(2,6,23,0.5); align-items:center; justify-content:center; z-index:1000}
  .modal-panel{width:100%; max-width:780px; background:#fff; border-radius:12px; padding:20px;}
  .address-card{border:1px solid #eee; padding:12px; border-radius:8px; display:flex; gap:12px; align-items:flex-start}
  .address-card.selected{border-color:var(--brand); background: #fffaf5}

  .inline-form-row{display:flex; gap:8px; flex-wrap:wrap}
  .inline-form-row input, .inline-form-row select{flex:1; min-width:140px; padding:8px; border:1px solid #e8e8e8; border-radius:6px}

  /* small utility */
  .text-right{text-align:right}
  .error-msg{color:#b00020; font-weight:700; margin-top:8px}
  .success-msg{color:green; font-weight:700; margin-top:8px}
</style>

<div class="checkout-wrap">
  <div class="card" style="margin-bottom:12px">
    <div class="steps" role="list" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠">
      <div class="step" role="listitem">
        <div class="circle {% if step == 1 %}active{% else %}inactive{% endif %}">{% if step > 1 %}‚úì{% else %}1{% endif %}</div>
        <div class="step-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
      </div>
      <div class="step" role="listitem">
        <div class="circle {% if step == 2 %}active{% else %}inactive{% endif %}">{% if step > 2 %}‚úì{% else %}2{% endif %}</div>
        <div class="step-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
      </div>
      <div class="step" role="listitem">
        <div class="circle {% if step == 3 %}active{% else %}inactive{% endif %}">{% if step == 3 %}‚úì{% else %}3{% endif %}</div>
        <div class="step-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
      </div>
    </div>
  </div>

  <div class="checkout-grid">

    <div>

      {% if step == 1 %}
      <form method="POST" id="step1Form" class="card" aria-labelledby="step1Heading">
        {% csrf_token %}
        <input type="hidden" name="checkout_step" value="1">
        <input type="hidden" name="selected_item_ids_str" value="{{ selected_item_ids_str }}">
        <input type="hidden" name="address_id" id="selected_address_id" value="{% for address in addresses %}{% if address.is_default %}{{ address.id }}{% endif %}{% empty %}{% endfor %}" required>

        <div class="section-header">
          <div>
            <div class="section-title" id="step1Heading">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
            <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          </div>
          <div>
            <button type="button" id="openAddressModal" class="change-link" aria-haspopup="dialog">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
          </div>
        </div>

        <div style="margin-top:12px;" id="currentAddressDisplay">
          {% with default_address=addresses|first %}
            {% if default_address %}
              <div class="current-address">
                <strong data-id="{{ default_address.id }}">{{ default_address.full_name }} | {{ default_address.phone }}</strong>
                <div id="currentAddressText">{{ default_address.address_line }} ‡∏ï.{{ default_address.subdistrict }} ‡∏≠.{{ default_address.district }} ‡∏à.{{ default_address.province }} {{ default_address.zipcode }}</div>
              </div>
            {% else %}
              <p style="color:red;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>
              <p><a href="{% url 'petjoy:address_add' %}" class="btn btn-primary" style="display:inline-block; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</a></p>
            {% endif %}
          {% endwith %}
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #f0f0f0">

        <div>
          <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
          <div class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>

          <div class="items-list" style="margin-top:12px">
            
            {% for shop_data in checkout_shops %}
              <div class="shop-group">
                  <div class="shop-header">
                      <i class="fa-solid fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô: {{ shop_data.owner.store_name }}
                  </div>
                  
                  {% for item in shop_data.items %}
                    <div class="item-row" aria-label="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ {{ item.product.name }}">
                      <img src="{% if item.product.image %}{{ item.product.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}" alt="‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ {{ item.product.name }}" class="item-img">
                      <div class="item-meta">
                        <div style="font-weight:700">{{ item.product.name }}</div>
                        <div class="muted">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ item.product.id }}</div>
                      </div>
                      <div class="item-price">‡∏ø{{ item.product.price|floatformat:2|intcomma }} &times; {{ item.quantity }} = <div style="font-weight:900;">‡∏ø{{ item.total_price|floatformat:2|intcomma }}</div></div>
                    </div>
                  {% endfor %}

                  <div style="background:#fff;">
                      <div class="price-summary-row" style="margin-top:10px;">
                          <span>‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ:</span>
                          <span>‡∏ø{{ shop_data.subtotal|intcomma }}</span>
                      </div>
                      <div class="price-summary-row">
                          <span>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢:</span>
                          <span>‡∏ø{{ shop_data.shipping|intcomma }}</span>
                      </div>
                      <div class="price-summary-row total">
                          <span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ:</span>
                          <span style="color:var(--brand); font-size: 1rem;">
                              ‡∏ø{{ shop_data.shop_total|intcomma }}
                          </span>
                      </div>
                  </div>
              </div>
            {% endfor %}

            <div class="total-line">
              <div class="muted">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
              <div class="summary-total">‡∏ø{{ total_price|floatformat:2|intcomma }}</div>
            </div>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:18px; gap:10px;">
          <a href="{% url 'petjoy:cart-detail' %}" class="btn btn-ghost">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
          <button type="submit" class="btn btn-primary">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </form>
      {% endif %}


      {% if step == 2 %}
      <div class="card">
        <h3 class="section-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <div class="muted" style="margin-bottom:12px">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</div>

        <div style="margin-top:8px">
          <div class="section-header">
            <div>
              <strong>{{ address.full_name }} | {{ address.phone }}</strong>
              <div class="muted">{{ address.address_line }} ‡∏ï.{{ address.subdistrict }} ‡∏≠.{{ address.district }} ‡∏à.{{ address.province }} {{ address.zipcode }}</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="section-title">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Net Total)</div>
          <div class="muted">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
          <div style="text-align:right; margin-top:6px; font-weight:900; font-size:1.4rem; color:var(--brand)">‡∏ø{{ total_price|floatformat:2|intcomma }}</div>
        </div>

        {% if messages %}
          {% for message in messages %}
            <div role="alert" style="color:red; margin-bottom:10px">{{ message }}</div>
          {% endfor %}
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="step2Form" style="margin-top:16px">
          {% csrf_token %}
          <input type="hidden" name="checkout_step" value="2">

          <div class="section-title" style="margin-bottom:8px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>

          <div class="payment-list">
            <label class="payment-card">
              <input type="radio" id="bank_transfer" name="payment_method" value="bank_transfer" required onclick="togglePaymentSection()">
              <div style="flex:1">
                <div style="font-weight:800; font-size:1.1rem;">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                
                <div id="bankDetailsContainer" class="bank-details" style="margin-top:15px; display:none;">
                  
                  <div style="background-color: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ffb74d;">
                    <i class="fa-solid fa-triangle-exclamation" style="color: #ef6c00;"></i> 
                    <span style="color: #ef6c00; font-weight: 600;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>
                  </div>

                  {% for shop_data in checkout_shops %}
                    <div class="shop-transfer-group">
                      <div class="shop-title">
                        <i class="fa-solid fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô: {{ shop_data.owner.store_name }}
                      </div>
                      
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 8px;">
                          <div style="line-height: 1.6;">
                              {% if shop_data.owner.bank_name %}
                                <div style="font-weight: bold; color: var(--brand);">{{ shop_data.owner.bank_name }}</div>
                                <div>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <strong>{{ shop_data.owner.account_number }}</strong></div>
                                <div>‡∏ä‡∏∑‡πà‡∏≠: {{ shop_data.owner.account_name }}</div>
                              {% else %}
                                <div style="color:red; font-weight:600">*‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ*</div>
                              {% endif %}
                          </div>
                          
                          <div style="text-align: right; font-size: 0.9rem; color: #666;">
                              <div>‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏ø{{ shop_data.subtotal|intcomma }}</div>
                              <div>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ‡∏ø{{ shop_data.shipping|intcomma }}</div>
                              <div style="margin-top: 5px; font-weight: bold; color: #333; font-size: 1.1rem;">
                                  ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô: <span style="color:#e65100;">‡∏ø{{ shop_data.shop_total|intcomma }}</span>
                              </div>
                          </div>
                      </div>

                      <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 10px;">
                          <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">
                              üìé ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î ‡∏ø{{ shop_data.shop_total|intcomma }}):
                          </label>
                          <input type="file" name="payment_slip_{{ shop_data.owner.id }}" accept="image/*,.pdf" class="shop-slip-input" style="width: 100%;">
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </label>

            <label class="payment-card">
              <input type="radio" id="cod" name="payment_method" value="cod" onclick="togglePaymentSection()">
              <div style="flex:1">
                <div style="font-weight:800">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</div>
                <div class="muted">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß)</div>
              </div>
            </label>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:18px">
            <button type="submit" class="btn btn-primary" id="confirmOrderBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
          </div>
        </form>
      </div>
      {% endif %}

      {% if step == 3 %}
      <div class="card">
        <div style="text-align:center; padding:18px">
          <div style="font-size:2.2rem; color:var(--accent); font-weight:900">‚úì</div>
          <h2 style="margin:8px 0; color:var(--accent)">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h2>
          <div class="muted">‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</div>
        </div>

        <div style="margin-top:12px">
          <div class="section-title">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
          <div class="muted">{{ address.full_name }} | {{ address.phone }}</div>
          <div style="margin-top:6px">{{ address.customer_address }}</div>
        </div>

        <div style="margin-top:12px">
          <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
          {% for order in orders %}
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0">
              <div>
                  <strong>Order #{{ order.id }}</strong> (‡∏£‡πâ‡∏≤‡∏ô: {{ order.entrepreneur.store_name }})<br>
                  <small style="color: #777;">(‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á ‡∏ø{{ order.shipping_cost|default:0 }})</small>
              </div>
              <div style="font-weight:800">‡∏ø{{ order.total_price|floatformat:2|intcomma }}</div>
            </div>
          {% endfor %}

          <div style="margin-top:12px; font-weight:900; display:flex; justify-content:space-between;">
            <div>‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div style="color:var(--brand);">‡∏ø{{ total_price|floatformat:2|intcomma }}</div>
          </div>
        </div>

        <div style="display:flex; gap:12px; justify-content:center; margin-top:16px">
          <a href="{% url 'petjoy:homepage' %}" class="btn btn-primary">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
          <a href="{% url 'petjoy:order_history' %}" class="btn btn-ghost">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
        </div>
      </div>
      {% endif %}

    </div>

    <aside class="summary-card">
      <div class="card">
        <div class="section-header">
          <div class="section-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
          <div class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>

        <div style="margin-top:12px">
          {% if step == 3 %}
             <div class="summary-row"><div class="muted">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="summary-total">‡∏ø{{ total_price|floatformat:2|intcomma }}</div></div>
          {% else %}
             {% for shop_data in checkout_shops %}
                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0">
                  <div style="max-width:65%">
                      {{ shop_data.owner.store_name }}<br>
                      <small class="muted">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ {{ shop_data.subtotal|intcomma }} + ‡∏™‡πà‡∏á {{ shop_data.shipping|intcomma }}</small>
                  </div>
                  <div style="font-weight:800">‡∏ø{{ shop_data.shop_total|floatformat:2|intcomma }}</div>
                </div>
             {% endfor %}
             
             <hr style="border:none; border-top:1px dashed #f0f0f0; margin:8px 0">

             <div class="summary-row"><div class="muted">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="summary-total">‡∏ø{{ total_price|floatformat:2|intcomma }}</div></div>
          {% endif %}
        </div>
      </div>
    </aside>

  </div>
</div>

<div id="addressModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel" role="document">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
      <button id="closeModal" aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
    </div>

    <form id="modalAddressForm">
      <div id="modalAddressList" style="display:flex; flex-direction:column; gap:10px; max-height:320px; overflow:auto; padding-bottom:6px;">
        {% for address in addresses %}
          <label class="address-card {% if address.is_default %}selected{% endif %}">
            <input type="radio" name="modal_address_id" value="{{ address.id }}" data-name="{{ address.full_name }} | {{ address.phone }}" data-detail="{{ address.address_line }} ‡∏ï.{{ address.subdistrict }} ‡∏≠.{{ address.district }} ‡∏à.{{ address.province }} {{ address.zipcode }}" {% if address.is_default %}checked{% endif %}>
            <div style="flex:1">
              <div style="font-weight:800">{{ address.full_name }} | {{ address.phone }}</div>
              <div class="muted">{{ address.address_line }} ‡∏ï.{{ address.subdistrict }} ‡∏≠.{{ address.district }} ‡∏à.{{ address.province }} {{ address.zipcode }}</div>
              {% if address.is_default %}<div style="color:green; font-weight:700; margin-top:6px">(‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</div>{% endif %}
            </div>
          </label>
        {% empty %}
          <div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</div>
        {% endfor %}
      </div>

      <div style="margin-top:12px; border-top:1px dashed #eee; padding-top:12px">
        <div class="section-title" style="font-size:0.98rem">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</div>
        <div class="muted" style="margin-bottom:8px">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</div>

        <div id="addAddressMsg"></div>

        <div class="inline-form-row">
          <input name="full_name" id="ia_full_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
          <input name="phone" id="ia_phone" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required>
          <input name="zipcode" id="ia_zipcode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå">
        </div>
        <div style="height:8px"></div>
        <div class="inline-form-row">
          <input name="address_line" id="ia_address_line" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ï‡∏£‡∏≠‡∏Å / ‡∏ñ‡∏ô‡∏ô" required>
          <input name="subdistrict" id="ia_subdistrict" placeholder="‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á" required>
          <input name="district" id="ia_district" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï" required>
          <input name="province" id="ia_province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" required>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:12px">
          <button type="button" id="addAddressBtn" class="btn btn-ghost">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
          <button type="button" id="confirmAddressChange" class="btn btn-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const addressModal = document.getElementById('addressModal');
    const openModalBtn = document.getElementById('openAddressModal');
    const closeModalBtn = document.getElementById('closeModal');
    const confirmBtn = document.getElementById('confirmAddressChange');
    const currentAddressDisplay = document.getElementById('currentAddressDisplay');
    const selectedAddressInput = document.getElementById('selected_address_id');

    function openModal(){ addressModal.style.display='flex'; addressModal.setAttribute('aria-hidden','false'); }
    function closeModal(){ addressModal.style.display='none'; addressModal.setAttribute('aria-hidden','true'); }

    if(openModalBtn){ openModalBtn.addEventListener('click', openModal); }
    if(closeModalBtn){ closeModalBtn.addEventListener('click', closeModal); }
    if(addressModal){ addressModal.addEventListener('click', (e)=>{ if(e.target===addressModal) closeModal(); }); }

    // highlight selected card
    function refreshRadioListeners(){
      const radios = document.querySelectorAll('input[name="modal_address_id"]');
      radios.forEach(r=>{
        r.addEventListener('change', ()=>{
          document.querySelectorAll('.address-card').forEach(c=>c.classList.remove('selected'));
          if(r.checked) r.closest('.address-card').classList.add('selected');
        });
        if(r.checked) r.closest('.address-card').classList.add('selected');
      });
    }
    refreshRadioListeners();

    if(confirmBtn){
      confirmBtn.addEventListener('click', ()=>{
        const sel = document.querySelector('input[name="modal_address_id"]:checked');
        if(!sel){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'); return; }
        selectedAddressInput.value = sel.value;
        const name = sel.dataset.name || '';
        const detail = sel.dataset.detail || '';
        const strongEl = currentAddressDisplay.querySelector('strong');
        const pEl = currentAddressDisplay.querySelector('div#currentAddressText');
        if(strongEl) strongEl.textContent = name;
        if(pEl) pEl.textContent = detail;
        closeModal();
      });
    }

    // Add address (AJAX)
    const addBtn = document.getElementById('addAddressBtn');
    const addMsg = document.getElementById('addAddressMsg');
    const modalList = document.getElementById('modalAddressList');

    function clearAddForm(){
      ['ia_full_name','ia_phone','ia_zipcode','ia_address_line','ia_subdistrict','ia_district','ia_province'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
    }

    if(addBtn){
      addBtn.addEventListener('click', async ()=>{
        addMsg.innerHTML = '';
        const data = {
          full_name: document.getElementById('ia_full_name').value.trim(),
          phone: document.getElementById('ia_phone').value.trim(),
          zipcode: document.getElementById('ia_zipcode').value.trim(),
          address_line: document.getElementById('ia_address_line').value.trim(),
          subdistrict: document.getElementById('ia_subdistrict').value.trim(),
          district: document.getElementById('ia_district').value.trim(),
          province: document.getElementById('ia_province').value.trim(),
        };
        // basic validation client-side
        if(!data.full_name || !data.phone || !data.address_line || !data.subdistrict || !data.district || !data.province){
          addMsg.innerHTML = '<div class="error-msg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</div>';
          return;
        }
        addBtn.disabled = true;
        addBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';
        try{
          const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
          const resp = await fetch("{% url 'petjoy:address_add' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrf,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
          });
          if(resp.ok){
            const j = await resp.json();
            if(j.success && j.address){
              addMsg.innerHTML = '<div class="success-msg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>';
              // Append new address to modal list
              const a = j.address;
              const label = document.createElement('label');
              label.className = 'address-card';
              label.innerHTML = `<input type="radio" name="modal_address_id" value="${a.id}" data-name="${a.full_name} | ${a.phone}" data-detail="${a.address_line} ‡∏ï.${a.subdistrict} ‡∏≠.${a.district} ‡∏à.${a.province} ${a.zipcode}" checked>
                <div style="flex:1">
                  <div style="font-weight:800">${a.full_name} | ${a.phone}</div>
                  <div class="muted">${a.address_line} ‡∏ï.${a.subdistrict} ‡∏≠.${a.district} ‡∏à.${a.province} ${a.zipcode}</div>
                </div>`;
              modalList.prepend(label);
              // Set as selected in UI and update current display immediately
              refreshRadioListeners();
              const sel = label.querySelector('input[name="modal_address_id"]');
              sel.checked = true;
              selectedAddressInput.value = a.id;
              const strongEl = currentAddressDisplay.querySelector('strong');
              const pEl = currentAddressDisplay.querySelector('div#currentAddressText');
              if(strongEl) strongEl.textContent = `${a.full_name} | ${a.phone}`;
              if(pEl) pEl.textContent = `${a.address_line} ‡∏ï.${a.subdistrict} ‡∏≠.${a.district} ‡∏à.${a.province} ${a.zipcode}`;
              clearAddForm();
            }else{
              addMsg.innerHTML = `<div class="error-msg">${j.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ'}</div>`;
            }
          } else {
            const txt = await resp.text();
            addMsg.innerHTML = '<div class="error-msg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (server)</div>';
            console.error('address add failed', resp.status, txt);
          }
        }catch(e){
          console.error(e);
          addMsg.innerHTML = '<div class="error-msg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>';
        } finally {
          addBtn.disabled = false;
          addBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
        }
      });
    }

    // Step 2 slip upload behaviour + client-side validation
    const bankRadio = document.getElementById('bank_transfer');
    const codRadio = document.getElementById('cod');
    const bankDetails = document.getElementById('bankDetailsContainer');
    const step2Form = document.getElementById('step2Form');

    function togglePaymentDisplay(){
      if(bankRadio && bankRadio.checked){ 
          if(bankDetails) bankDetails.style.display = 'block'; 
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° required ‡πÉ‡∏´‡πâ input file ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ
          document.querySelectorAll('.shop-slip-input').forEach(el => el.required = true);
      } else { 
          if(bankDetails) bankDetails.style.display = 'none'; 
          // ‡πÄ‡∏≠‡∏≤ required ‡∏≠‡∏≠‡∏Å
          document.querySelectorAll('.shop-slip-input').forEach(el => el.required = false);
      }
    }

    if(bankRadio){ bankRadio.addEventListener('change', togglePaymentDisplay); }
    if(codRadio){ codRadio.addEventListener('change', togglePaymentDisplay); }
    
    // Run once on load
    try { togglePaymentDisplay(); } catch(e){}

    if(step2Form){
      step2Form.addEventListener('submit', function(e){
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
        const pay = document.querySelector('input[name="payment_method"]:checked');
        if(!pay){
          e.preventDefault();
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
          return;
        }
        if(pay.value === 'bank_transfer'){
          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏°
          let missing = false;
          document.querySelectorAll('.shop-slip-input').forEach(el => {
              if(!el.value) missing = true;
          });
          
          if(missing){
            e.preventDefault();
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
            return;
          }
        }
      });
    }

  })();
</script>

{% endblock %}