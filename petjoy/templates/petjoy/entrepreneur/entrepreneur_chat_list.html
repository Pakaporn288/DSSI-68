{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'entrepreneur.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .navbar { display: none !important; }

    .chat-list-layout {
        display: flex;
        max-width: 1200px;
        margin: 40px auto;
        gap: 30px;
        padding: 0 20px;
    }

    .chat-main-card {
        flex: 1;
        background: white;
        border-radius: 16px;
        padding: 26px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .chat-header h2 {
        font-size: 1.8rem;
        font-weight: 700;
        color: #E65100;
        margin-bottom: 25px;
    }

    /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó‡∏õ‡∏Å‡∏ï‡∏¥ */
    .chat-item-wrapper {
        background: white;
        margin-bottom: 12px;
        border-radius: 14px;
        border: 1px solid #eee; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏à‡∏≤‡∏á‡πÜ */
        transition: 0.2s;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        padding-right: 40px;
    }

    .chat-item-wrapper:hover {
        background: #FFEDE2;
        box-shadow: 0 4px 12px rgba(255,138,80,0.3);
    }

    /* ‚≠ê CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á Admin ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚≠ê */
    .chat-item-wrapper.admin-highlight {
        background: linear-gradient(to right, #fff9c4, #fff); /* ‡πÑ‡∏•‡πà‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        border: 2px solid #FFC107; /* ‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
        box-shadow: 0 4px 10px rgba(255, 193, 7, 0.2);
    }
    
    .chat-item-wrapper.admin-highlight:hover {
        background: #fff59d;
        box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3);
    }

    .chat-item-wrapper.admin-highlight .chat-name {
        color: #d32f2f; /* ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Badge ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ADMIN */
    .admin-badge {
        background-color: #d32f2f;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        text-transform: uppercase;
    }

    /* ------------------------------ */

    .chat-item {
        display: flex;
        padding: 15px;
        text-decoration: none;
        color: #333;
        align-items: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    }

    .chat-avatar {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
        border: 2px solid #FF8A50;
    }

    /* Avatar ‡∏Ç‡∏≠‡∏á Admin */
    .chat-avatar.admin-avatar {
        border: 2px solid #FFC107;
        padding: 2px;
        background: white;
    }

    .chat-info {
        flex-grow: 1;
    }

    .chat-name {
        font-weight: 700;
        font-size: 1.05rem;
        color: #E65100;
    }

    .chat-last-message {
        color: #777;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .chat-timestamp {
        font-size: 0.8rem;
        color: #999;
        padding-top: 5px;
        white-space: nowrap;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏°‡∏à‡∏∏‡∏î */
    .chat-more-btn {
        position: absolute;
        right: 15px;
        top: 18px;
        font-size: 18px;
        color: #999;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: 0.2s;
    }

    .chat-more-btn:hover {
        background: rgba(0,0,0,0.05);
        color: #E65100;
    }

    .chat-more-menu {
        position: absolute;
        right: 10px;
        top: 45px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        display: none;
        z-index: 10;
        overflow: hidden;
    }

    .chat-more-menu a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .chat-more-menu a:hover {
        background: #FFEDE2;
        color: #E65100;
    }

    .seller-sidebar .seller-menu a[href*="entrepreneur-chat-list"] {
        background-color: #FF8A50;
        color: white;
        border-left: 5px solid #E65100;
    }
</style>

<div class="seller-layout">

    <aside class="seller-sidebar">
        <div> 
            <div class="seller-profile">
                {% if entrepreneur.profile_image %}
                    <img src="{{ entrepreneur.profile_image.url }}" class="seller-avatar">
                {% else %}
                    <img src="{% static 'images/‡∏£‡πâ‡∏≤‡∏ô.png' %}" class="seller-avatar">
                {% endif %}
                <h3 class="seller-name">{{ entrepreneur.store_name }}</h3> 
                <p class="seller-username">@{{ entrepreneur.user.username }}</p>
            </div>

            <nav class="seller-menu">
                <a href="{% url 'petjoy:entrepreneur-home' %}">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≤‡∏ô</a>
                <a href="{% url 'petjoy:orders-list' %}">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a>
                <a href="{% url 'petjoy:product-list' %}">üõçÔ∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
                <a href="{% url 'petjoy:entrepreneur-chat-list' %}" class="active">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</a>
                <a href="{% url 'petjoy:entrepreneur_profile_settings' %}">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏£‡πâ‡∏≤‡∏ô</a>
                <a href="{% url 'petjoy:entrepreneur_reviews' %}">üìã ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
                <a href="{% url 'petjoy:entrepreneur-income' %}">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</a>
            </nav>
        
            <form method="post" action="{% url 'petjoy:logout' %}">
                {% csrf_token %}
                <button class="seller-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </aside>

    <main class="seller-main">
        <div class="chat-main-card">
            <div class="chat-header">
                <h2>üí¨ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
            </div>

            <section class="chat-list">
                {% for room in rooms %}
                    <div class="chat-item-wrapper {% if room.customer.is_superuser %}admin-highlight{% endif %}">

                        <div class="chat-more-btn" onclick="toggleMenu({{ room.id }})">
                            ‚ãÆ
                        </div>

                        <div class="chat-more-menu" id="menu-{{ room.id }}">
                            <a href="{% url 'petjoy:entrepreneur-chat-delete' room.id %}">üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ä‡∏ó</a>
                        </div>

                        <a href="{% url 'petjoy:entrepreneur-chat-room' room.id %}" class="chat-item">
                            
                            {% if room.customer.is_superuser %}
                                <div style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; background: #FFC107; border-radius: 50%; margin-right: 15px; border: 2px solid #FFA000;">
                                    <i class="fa-solid fa-headset" style="font-size: 24px; color: #fff;"></i>
                                </div>
                            {% else %}
                                {% with room.customer.profile as customer_profile %}
                                    {% if customer_profile.image %}
                                        <img src="{{ customer_profile.image.url }}" class="chat-avatar">
                                    {% else %}
                                        <img src="{% static 'images/customer_default.png' %}" class="chat-avatar">
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                            
                            <div class="chat-info">
                                <div class="chat-name">
                                    {% if room.customer.is_superuser %}
                                        <span>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (PetJoy Support)</span>
                                        <span class="admin-badge">ADMIN</span>
                                    {% else %}
                                        ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {{ room.customer.username }}
                                    {% endif %}
                                </div>
                                
                                <div class="chat-last-message">
                                    {% with room.messages.last as last_message %}
                                        {% if last_message %}
                                            {% if last_message.sender == current_user %}‡∏Ñ‡∏∏‡∏ì: {% endif %}
                                            {{ last_message.message|truncatechars:40 }}
                                        {% else %}
                                            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                            
                            <div class="chat-timestamp">
                                {% with room.messages.last as last_message %}
                                    {% if last_message.timestamp %}
                                        {{ last_message.timestamp|date:"d M H:i" }}
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </a>
                    </div>
                {% empty %}
                    <div style="text-align: center; padding: 40px; color: #777;">
                        <p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏î ‡πÜ</p>
                    </div>
                {% endfor %}
            </section>
        </div>
    </main>
</div>

<script>
function toggleMenu(id) {
    document.querySelectorAll('.chat-more-menu').forEach(m => {
        if (m.id !== "menu-" + id) m.style.display = "none";
    });

    const menu = document.getElementById("menu-" + id);
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

document.addEventListener("click", function(e) {
    if (!e.target.classList.contains("chat-more-btn")) {
        document.querySelectorAll('.chat-more-menu').forEach(m => m.style.display = "none");
    }
});
</script>

{% endblock %}