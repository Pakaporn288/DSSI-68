{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'entrepreneur.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .navbar { display: none !important; }

    /* ‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏•‡∏±‡∏Å */
    .chat-layout {
        display: flex;
        max-width: 1200px;
        margin: 35px auto;
        gap: 25px;
        padding: 0 25px;
    }

    /* ‡∏ã‡πâ‡∏≤‡∏¢ ‚Äì Quick Replies */
    .quick-sidebar {
        flex: 1;
        background: white;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 5px 18px rgba(0,0,0,0.08);
        border: 1px solid #FFE2D2;
        height: 75vh;
        overflow-y: auto;
    }

    .quick-sidebar h3 {
        font-size: 1.3rem;
        color: #E65100;
        font-weight: 800;
        margin-bottom: 18px;
    }

    .quick-button {
        background: #FFF5EF;
        border: 1px solid #FF8A50;
        padding: 12px 15px;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 10px;
        font-size: 0.95rem;
        color: #333;
        transition: 0.2s;
    }
    .quick-button:hover {
        background: #FF8A50;
        color: white;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏Å */
    .chat-card {
        flex: 3;
        background: white;
        border-radius: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 75vh;
        overflow: hidden;
    }

    /* Header */
    .chat-header {
        padding: 20px 25px;
        border-bottom: 1px solid #FFE2D2;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-user-avatar {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        border: 2px solid #FF8A50;
        object-fit: cover;
    }

    .chat-user-name {
        font-size: 1.2rem;
        font-weight: 800;
        color: #E65100;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
    .back-btn {
        font-size: 20px;
        color: #E65100;
        margin-right: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        transition: 0.2s;
        text-decoration: none;
    }
    .back-btn:hover {
        background: #FFF1E7;
        color: #BF4B00;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π */
    .chat-menu-btn {
        font-size: 24px;
        cursor: pointer;
        color: #777;
        padding: 8px;
        border-radius: 8px;
    }
    .chat-menu-btn:hover {
        background: #FFF1E7;
        color: #E65100;
    }

    .chat-menu {
        position: absolute;
        right: 25px;
        top: 75px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        display: none;
        z-index: 20;
        overflow: hidden;
    }

    .chat-menu a {
        display: block;
        padding: 12px 18px;
        text-decoration: none;
        color: #333;
        font-size: 0.95rem;
    }
    .chat-menu a:hover {
        background: #FFEDE2;
        color: #E65100;
    }

    /* Messages */
    .messages-area {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background: #FFF8F5;
    }

    /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
    .chat-date {
        text-align: center;
        font-size: 0.8rem;
        color: #777;
        margin: 15px 0;
    }

    .bubble {
        max-width: 70%;
        width: fit-content; 
        padding: 12px 18px;
        border-radius: 18px;
        margin-bottom: 12px;
        line-height: 1.5;
        font-size: 0.97rem;
        word-wrap: break-word;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .sent {
        background: #FF8A50;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }

    .received {
        background: #ffffff;
        color: #333;
        border-bottom-left-radius: 5px;
    }

    .time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }

    /* ‚≠ê CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó */
    .chat-image {
        max-width: 100%;
        width: auto;
        height: auto;
        border-radius: 12px;
        margin-bottom: 5px;
        display: block;
        cursor: pointer;
    }

    /* Input */
    .chat-input-area {
        padding: 15px 20px;
        border-top: 1px solid #FFE2D2;
        display: flex;
        gap: 12px;
    }

    .chat-input {
        flex: 1;
        padding: 14px 18px;
        border-radius: 25px;
        border: 1px solid #FF8A50;
        font-size: 1rem;
        outline: none;
    }
    .chat-input:focus {
        border-color: #E65100;
        box-shadow: 0 0 0 3px #FFEDE2;
    }

    .send-btn {
        background: #FF8A50;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
    }
    .send-btn:hover {
        background: #E65100;
    }

    .attach-btn {
        background: #35a782;
        color: white;
        padding: 12px 16px;
        border-radius: 50%;
        border: none;
        font-size: 1rem;
        cursor: pointer;
    }
</style>

<div class="chat-layout">

    <div class="quick-sidebar">
        <h3>‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πà‡∏ß‡∏ô</h3>

        {% if quick_replies %}
            {% for qr in quick_replies %}
                <div class="quick-button"
                     onclick="insertQuick('{{ qr.message|escapejs }}')">
                    {{ qr.message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="chat-card">

        <div class="chat-header">
            <div class="chat-user-info">
                <a href="{% url 'petjoy:entrepreneur-chat-list' %}" class="back-btn">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>

                {% if room.customer.is_superuser %}
                    <div style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; background: #FFC107; border-radius: 50%; border: 2px solid #FFA000;">
                        <i class="fa-solid fa-headset" style="font-size: 24px; color: #fff;"></i>
                    </div>
                {% else %}
                    {% if room.customer.profile.image %}
                        <img src="{{ room.customer.profile.image.url }}" class="chat-user-avatar">
                    {% else %}
                        <img src="{% static 'images/customer_default.png' %}" class="chat-user-avatar">
                    {% endif %}
                {% endif %}

                <div class="chat-user-name">
                    {% if room.customer.is_superuser %}
                        ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (PetJoy Support)
                    {% else %}
                        {{ room.customer.username }}
                    {% endif %}
                </div>
            </div>

            <div class="chat-menu-btn" onclick="toggleMenu()">‚ãÆ</div>
            <div class="chat-menu" id="chatMenu">
                <a href="{% url 'petjoy:entrepreneur-chat-delete' room.id %}">üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ</a>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            {% for message in messages %}
                {% ifchanged message.local_date %}
                    <div class="chat-date">
                        {{ message.date_label }}
                    </div>
                {% endifchanged %}

                <div class="bubble {% if message.sender == current_user %}sent{% else %}received{% endif %}">
                    <div class="message-content">
                        {% if message.attachment %}
                            <a href="{{ message.attachment.url }}" target="_blank">
                                <img src="{{ message.attachment.url }}" class="chat-image" alt="sent image">
                            </a>
                        {% endif %}

                        {% if message.message %}
                            {{ message.message|safe }}
                        {% endif %}
                    </div>
                    <div class="time">{{ message.timestamp|date:"H:i" }}</div>
                </div>
            {% endfor %}
        </div>

        <form method="post" class="chat-input-area" enctype="multipart/form-data" id="chatForm">
            {% csrf_token %}

            <input type="file" id="fileAttachment" name="attachment" hidden accept="image/*">

            <button type="button" class="attach-btn"
                    onclick="document.getElementById('fileAttachment').click();">
                <i class="fas fa-paperclip"></i>
            </button>

            <input type="text" name="message" id="chatInput"
                   class="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." autocomplete="off">

            <button type="submit" class="send-btn">‡∏™‡πà‡∏á</button>
        </form>

    </div>
</div>

<script>
function toggleMenu() {
    let menu = document.getElementById("chatMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

document.addEventListener("click", function(e) {
    if (!e.target.classList.contains("chat-menu-btn")) {
        document.getElementById("chatMenu").style.display = "none";
    }
});

function insertQuick(text) {
    let input = document.getElementById("chatInput");
    input.value = text;
    input.focus();
}

window.onload = function() {
    let box = document.getElementById("messagesArea");
    box.scrollTop = box.scrollHeight;
};

// ‚≠ê ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‚≠ê
document.getElementById('fileAttachment').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        // Submit Form ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.getElementById('chatForm').submit();
    }
});
</script>

{% endblock %}