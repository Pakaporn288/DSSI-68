{% extends 'petjoy/admin/admin_base.html' %}
{% load humanize %}

{% block title %}Product & Sales Analytics{% endblock %}
{% block page_title %}üì¶ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤{% endblock %}

{% block nav_orders %}active{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* --- Summary Cards (Gradient & Icons) --- */
    .stats-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 35px;
    }

    .summary-card {
        position: relative;
        overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á */
        color: #fff;
        padding: 30px 25px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 140px;
        transition: transform 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-card h3 {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 5px 0 0 0;
        z-index: 2;
    }

    .summary-card p {
        font-size: 1.0rem;
        font-weight: 500;
        margin: 0;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
        z-index: 2;
    }

    /* Gradients */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    }
    .bg-gradient-success {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
    }
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
    }

    /* Floating Icon Background */
    .card-icon-bg {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%) rotate(-15deg);
        font-size: 5rem;
        opacity: 0.2;
        color: #000;
        pointer-events: none;
        z-index: 1;
    }

    /* --- Analytics Grid --- */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        display: flex;
        flex-direction: column;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .chart-header h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #4e73df;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .full-width {
        grid-column: 1 / -1;
    }

    /* Filter Buttons */
    .filter-group {
        background: #f8f9fc;
        padding: 4px;
        border-radius: 30px;
        display: flex;
    }
    
    .btn-filter {
        padding: 5px 15px;
        border-radius: 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.8rem;
        color: #858796;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-filter.active {
        background: #fff;
        color: #4e73df;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Graph Containers */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    .chart-container-small {
        position: relative;
        height: 200px; /* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 200px ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */
        width: 100%;
        display: flex;
        justify-content: center;
    }

    @media (max-width: 992px) {
        .analytics-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="stats-summary-grid">
    <div class="summary-card bg-gradient-success">
        <p>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</p>
        <h3>‡∏ø{{ total_revenue|floatformat:2|intcomma }}</h3>
        <i class="fas fa-wallet card-icon-bg"></i>
    </div>

    <div class="summary-card bg-gradient-primary">
        <p>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
        <h3>{{ total_orders_count|intcomma }}</h3>
        <i class="fas fa-shopping-cart card-icon-bg"></i>
    </div>

    <div class="summary-card bg-gradient-warning">
        <p>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
        <h3>{{ total_shops|intcomma }}</h3>
        <i class="fas fa-store card-icon-bg"></i>
    </div>
</div>

<div class="analytics-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h4><i class="fas fa-trophy"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡∏ä‡∏¥‡πâ‡∏ô)</h4>
        </div>
        <div class="chart-container">
            <canvas id="topProductsChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h4><i class="fas fa-medal"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (‡∏ä‡∏¥‡πâ‡∏ô)</h4>
        </div>
        <div class="chart-container">
            <canvas id="topShopsChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h4><i class="fas fa-chart-pie"></i> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h4>
            <div class="filter-group">
                <button class="btn-filter active" onclick="updateCategoryChart('all', this)">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                <button class="btn-filter" onclick="updateCategoryChart('food', this)">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
            </div>
        </div>
        <div class="chart-container-small"> <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <div class="chart-card full-width">
        <div class="chart-header">
            <h4><i class="fas fa-chart-line"></i> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h4>
        </div>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>

<script>
    Chart.defaults.font.family = "'Sarabun', 'Nunito', sans-serif";
    Chart.defaults.color = '#858796';

    // --- ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Views (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô JSON String ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ |safe) ---
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JSON.parse() ‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤ Views ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô json.dumps() ‡πÅ‡∏•‡πâ‡∏ß
    const topProductsLabels = {{ top_products_labels|safe }};
    const topProductsData = {{ top_products_data|safe }};
    
    const topShopsLabels = {{ top_shops_labels|safe }};
    const topShopsData = {{ top_shops_data|safe }};

    const catLabelsAll = {{ category_labels|safe }};
    const catDataAll = {{ category_data|safe }};
    
    const catLabelsFood = {{ food_type_labels|safe }};
    const catDataFood = {{ food_type_data|safe }};
    
    const revenueLabels = {{ revenue_labels|safe }};
    const revenueData = {{ revenue_data|safe }};

    // 1. Top Products Chart
    new Chart(document.getElementById('topProductsChart'), {
        type: 'bar',
        data: {
            labels: topProductsLabels,
            datasets: [{
                label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ä‡∏¥‡πâ‡∏ô)',
                data: topProductsData,
                backgroundColor: '#4e73df',
                borderRadius: 5,
                barPercentage: 0.6
            }]
        },
        options: {
            indexAxis: 'y', // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });

    // 2. Top Shops Chart
    new Chart(document.getElementById('topShopsChart'), {
        type: 'bar',
        data: {
            labels: topShopsLabels,
            datasets: [{
                label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ä‡∏¥‡πâ‡∏ô)',
                data: topShopsData,
                backgroundColor: '#f6c23e',
                borderRadius: 5,
                barPercentage: 0.6
            }]
        },
        options: {
            indexAxis: 'y', // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });

    // 3. Category Chart (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å)
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    let categoryChart = new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: catLabelsAll,
            datasets: [{
                data: catDataAll,
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏î‡∏ï‡∏≤‡∏° Container
            plugins: {
                legend: { 
                    position: 'right', 
                    labels: { boxWidth: 10, font: {size: 11} } // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Font Legend
                }
            },
            cutout: '70%'
        }
    });

    function updateCategoryChart(type, btn) {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (type === 'all') {
            categoryChart.data.labels = catLabelsAll;
            categoryChart.data.datasets[0].data = catDataAll;
        } else {
            categoryChart.data.labels = catLabelsFood;
            categoryChart.data.datasets[0].data = catDataFood;
        }
        categoryChart.update();
    }

    // 4. Revenue Chart (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ)
    new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                data: revenueData,
                borderColor: '#1cc88a',
                backgroundColor: 'rgba(28, 200, 138, 0.05)',
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#1cc88a',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '‡∏ø' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => '‡∏ø' + v.toLocaleString() },
                    grid: { borderDash: [2, 2] }
                },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}