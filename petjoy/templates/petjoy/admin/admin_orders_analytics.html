{% extends 'petjoy/admin/admin_base.html' %}
{% load humanize %}

{% block title %}Product & Sales Analytics{% endblock %}
{% block page_title %}üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠{% endblock %}

{% block nav_orders %}active{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ */
    .stats-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-card .icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á */
    .summary-card.blue .icon { background: #e3f2fd; color: #1976d2; }
    .summary-card.red .icon { background: #ffebee; color: #c62828; }
    .summary-card.green .icon { background: #e8f5e9; color: #2e7d32; }

    .summary-card .info h3 {
        margin: 0;
        font-size: 0.9rem;
        color: #666;
        font-weight: normal;
    }

    .summary-card .info .number {
        margin: 5px 0;
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
    }

    .summary-card .info small {
        color: #999;
        font-size: 0.8rem;
    }
</style>

<div class="stats-summary-grid">
    <div class="summary-card blue">
        <div class="icon">üì¶</div>
        <div class="info">
            <h3>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <p class="number">{{ total_products_count|intcomma }}</p>
            <small>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</small>
        </div>
    </div>

    <div class="summary-card red">
        <div class="icon">‚ö†Ô∏è</div>
        <div class="info">
            <h3>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
            <p class="number">{{ out_of_stock_count|intcomma }}</p>
            <small>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</small>
        </div>
    </div>

    <div class="summary-card green">
        <div class="icon">üõí</div>
        <div class="info">
            <h3>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</h3>
            <p class="number">{{ total_orders_count|intcomma }}</p>
            <small>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small>
        </div>
    </div>
</div>

<div class="stats-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 30px;">
    
    <div class="stat-card">
        <h4>üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h4>
        <canvas id="topProductsChart"></canvas>
    </div>

    <div class="stat-card">
        <h4>üìä ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h4>
        <div style="height: 250px; display: flex; justify-content: center;">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<div class="admin-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <span style="font-size: 0.9rem; color: #666;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
    </div>

    <table class="admin-table">
        <thead>
            <tr>
                <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                <th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
        </thead>
        <tbody>
            {% for product in all_products %}
            <tr>
                <td>
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="img" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                    {% else %}
                        <div style="width: 40px; height: 40px; background: #eee; border-radius: 4px;"></div>
                    {% endif %}
                </td>
                <td>
                    <strong>{{ product.name }}</strong><br>
                    <small style="color: #888;">ID: {{ product.id }}</small>
                </td>
                <td>
                    <span class="badge" style="background: #e3f2fd; color: #0d47a1; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;">
                        {{ product.category.display_name }}
                    </span>
                </td>
                <td>{{ product.owner.store_name }}</td>
                <td>‡∏ø{{ product.price|intcomma }}</td>
                <td>
                    {% if product.stock == 0 %}
                        <span style="color: red; font-weight: bold;">0 (‡∏´‡∏°‡∏î)</span>
                    {% else %}
                        {{ product.stock }}
                    {% endif %}
                </td>
                <td>
                    {% if product.stock > 0 %}
                        <span class="badge" style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px;">‡∏ß‡∏≤‡∏á‡∏Ç‡∏≤‡∏¢</span>
                    {% else %}
                        <span class="badge" style="background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align:center; padding: 20px; color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Config ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Chart)
    const ctxProduct = document.getElementById('topProductsChart').getContext('2d');
    new Chart(ctxProduct, {
        type: 'bar',
        data: {
            labels: {{ product_labels|safe }},
            datasets: [{
                label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ä‡∏¥‡πâ‡∏ô)',
                data: {{ product_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { stepSize: 1 } // ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡∏ô Y ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
                }
            }
        }
    });

    // Config ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó (Doughnut Chart)
    const ctxCategory = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCategory, {
        type: 'doughnut',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                data: {{ category_data|safe }},
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>

{% endblock %}